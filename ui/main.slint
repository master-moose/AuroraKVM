// AuroraKVM Configuration UI
import { Button, VerticalBox, HorizontalBox, ScrollView } from "std-widgets.slint";

// Screen rectangle component
component ScreenRect {
    in property <string> label: "Screen";
    in-out property <length> rect-x: 0px;
    in-out property <length> rect-y: 0px;
    in property <length> rect-width: 192px;
    in property <length> rect-height: 108px;
    in property <color> bg-color: #2c5632;
    in property <color> border-color: #4caf50;
    in property <bool> is-connected: false;
    in property <bool> draggable: false;
    
    callback moved(length, length);
    
    // Drag state
    property <length> drag-offset-x: 0px;
    property <length> drag-offset-y: 0px;
    property <bool> is-dragging: false;

    Rectangle {
        x: rect-x + drag-offset-x;
        y: rect-y + drag-offset-y;
        width: rect-width;
        height: rect-height;
        background: bg-color;
        border-width: 2px;
        border-color: border-color;
        border-radius: 5px;

        Text {
            text: label;
            color: white;
            horizontal-alignment: center;
            vertical-alignment: center;
            font-size: 12px;
        }

        // Connected indicator
        if is-connected: Rectangle {
            x: 5px;
            y: 5px;
            width: 10px;
            height: 10px;
            background: #76ff80;
            border-radius: 5px;
        }
        
        // Drag handler for connected clients
        if draggable: TouchArea {
            width: parent.width;
            height: parent.height;
            
            moved => {
                if self.pressed {
                    root.drag-offset-x = self.mouse-x - self.pressed-x;
                    root.drag-offset-y = self.mouse-y - self.pressed-y;
                    root.is-dragging = true;
                }
            }
            
            pointer-event(event) => {
                if (event.kind == PointerEventKind.up && root.is-dragging) {
                    // Commit the drag
                    root.moved(rect-x + drag-offset-x, rect-y + drag-offset-y);
                    root.drag-offset-x = 0px;
                    root.drag-offset-y = 0px;
                    root.is-dragging = false;
                }
            }
        }
    }
}

export struct Screen {
    name: string,
    x: float,
    y: float,
    width: float,
    height: float,
    connected: bool,
}

export component MainWindow inherits Window {
    title: "AuroraKVM Configuration";
    preferred-width: 1200px;
    preferred-height: 800px;
   
    in-out property <string> status-text: "Ready";
    in-out property <bool> is-locked: false;
    in property <[Screen]> screens: [];
    
    callback save-config();
    callback add-client();
    callback screen-moved(int, float, float);
    
    VerticalBox {
        padding: 10px;
        
        // Toolbar
        HorizontalBox {
            height: 40px;
            
            Button {
                text: "âž• Add Client";
                clicked => { add-client(); }
            }
            
            Button {
                text: root.is-locked ? "ðŸ”’ Locked" : "ðŸ”“ Unlocked";
                clicked => { root.is-locked = !root.is-locked; }
            }
            
            Button {
                text: "ðŸ’¾ Save";
                clicked => { save-config(); }
            }
            
            Rectangle { 
                horizontal-stretch: 1; 
            }
            
            Text {
                text: status-text;
                vertical-alignment: center;
                color: #666;
            }
        }
        
        // Canvas area
        Rectangle {
            background: #1e1e1e;
            border-width: 1px;
            border-color: #333;
            
            ScrollView {
                // No fixed dimensions - adapts to available space
                
                Rectangle {
                    width: 2000px;
                    height: 1500px;
                    
                    // Grid background (250px spacing)
                    for y in [0, 1, 2, 3, 4, 5, 6]: Rectangle {
                        y: y * 250px;
                        width: 2000px;
                        height: 1px;
                        background: #2a2a2a;
                    }
                    
                    for x in [0, 1, 2, 3, 4, 5, 6, 7, 8]: Rectangle {
                        x: x * 250px;
                        width: 1px;
                        height: 1500px;
                        background: #2a2a2a;
                    }
                    
                    // Render screens
                    for screen[i] in screens: ScreenRect {
                        label: screen.name;
                        rect-x: screen.x * 0.1px;
                        rect-y: screen.y * 0.1px;
                        rect-width: screen.width * 0.1px;
                        rect-height: screen.height * 0.1px;
                        bg-color: screen.connected ? #2d5c36 : #333333;
                        border-color: screen.connected ? #76ff80 : #555555;
                        draggable: screen.connected && !root.is-locked;
                        moved(new-x, new-y) => {
                            root.screen-moved(i, new-x / 0.1px, new-y / 0.1px);
                        }
                    }
                }
            }
        }
    }
}
